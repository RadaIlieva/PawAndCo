<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–†–µ–∑–µ—Ä–≤–∏—Ä–∞–π —á–∞—Å - Paw&Co</title>
  <link rel="stylesheet" href="/frontend/css/styles.css" />

  <header>
    <div class="header-content">
      <div class="logo-container">
        <img src="/frontend/images/logo.jpg" alt="–õ–æ–≥–æ" class="logo" />
        <h1>Paw&Co Grooming Studio</h1>
      </div>
      <nav>
        <a href="index.html" class="active">–ù–∞—á–∞–ª–æ</a>
        <a href="booking.html">–†–µ–∑–µ—Ä–≤–∏—Ä–∞–π —á–∞—Å</a>
        <a href="products.html">–ü—Ä–æ–¥—É–∫—Ç–∏</a>
        <a href="admin.html">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</a>
      </nav>
    </div>
  </header>

  <style>
    .booking-form {
      max-width: 500px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h2 { text-align: center; }

    .booking-form label {
      display: block;
      margin-top: 10px;
    }

    .booking-form input, .booking-form select, .booking-form button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    .calendar-container {
      display: none;
      margin-top: 15px;
    }

    .calendar-nav {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      align-items: center;
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }

    .day {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 5px;
      background: #f9f9f9;
      font-size: 0.8rem;
    }

    .day h4 {
      text-align: center;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    .hour {
      padding: 3px;
      margin: 2px 0;
      text-align: center;
      cursor: pointer;
      border-radius: 3px;
      background: #d4edda;
      font-size: 0.75rem;
    }

    .hour.booked {
      background: #f8d7da;
      cursor: not-allowed;
      color: #721c24;
    }

    .calendar-toggle {
      display: flex;
      align-items: center;
      margin-top: 10px;
      cursor: pointer;
    }

    .calendar-toggle img {
      width: 24px;
      margin-left: 5px;
    }

    #selectedHour {
      margin-top: 10px;
      font-weight: bold;
    }

    .nav-arrow {
      cursor: pointer;
      font-size: 1.2rem;
      font-weight: bold;
      padding: 0 10px;
      user-select: none;
    }
  </style>
</head>

<body>
<section class="booking">
  <h2>–†–µ–∑–µ—Ä–≤–∏—Ä–∞–π —á–∞—Å</h2>

  <form class="booking-form" id="bookingForm">
    <label>–ò–º–µ –Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–∏–∫–∞</label>
    <input type="text" id="ownerName" required>

    <label>–ò–º–µ –Ω–∞ –∫—É—á–µ—Ç–æ</label>
    <input type="text" id="dogName" required>

    <label>–ü–æ—Ä–æ–¥–∞</label>
    <input type="text" id="breed" required>

    <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
    <input type="text" id="phone" required>

    <div class="calendar-toggle">
      <span>–ò–∑–±–µ—Ä–∏ –¥–µ–Ω –∏ —á–∞—Å</span>
      <img src="images/calendar-icon.png" id="showCalendar" alt="–ö–∞–ª–µ–Ω–¥–∞—Ä">
    </div>

    <div class="calendar-container">
      <div class="calendar-nav">
        <span class="nav-arrow" id="prevWeek">&#8592;</span>
        <span>–°–µ–¥–º–∏—Ü–∞</span>
        <span class="nav-arrow" id="nextWeek">&#8594;</span>
      </div>
      <div class="calendar" id="calendar"></div>
    </div>

    <p id="selectedHour"></p>
    <button type="submit" class="btn">–†–µ–∑–µ—Ä–≤–∏—Ä–∞–π</button>
  </form>
</section>

<script>
const calendarContainer = document.querySelector('.calendar-container');
const calendar = document.getElementById('calendar');
const showCalendarBtn = document.getElementById('showCalendar');
const selectedHour = document.getElementById('selectedHour');
const prevWeekBtn = document.getElementById('prevWeek');
const nextWeekBtn = document.getElementById('nextWeek');

let selectedDate = '';
let selectedTime = '';
let weekStart = new Date(); // –¥–Ω–µ—à–Ω–∏—è—Ç –¥–µ–Ω –µ –Ω–∞—á–∞–ª–æ –Ω–∞ —Å–µ–¥–º–∏—Ü–∞—Ç–∞
let bookings = {}; // —â–µ –∑–∞—Ä–µ–∂–¥–∞–º–µ –æ—Ç –±–µ–∫–µ–Ω–¥–∞

// üü¢ –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –æ—Ç —Å—ä—Ä–≤—ä—Ä–∞
async function loadBookings() {
  const res = await fetch("/api/bookings");
  const data = await res.json();
  bookings = {};
  data.forEach(b => {
    if (!bookings[b.date]) bookings[b.date] = [];
    bookings[b.date].push(b.hour);
  });
  renderCalendar();
}

// üóìÔ∏è –ü–æ–∫–∞–∑–≤–∞–Ω–µ/—Å–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–∞
showCalendarBtn.addEventListener('click', () => {
  const visible = calendarContainer.style.display === 'block';
  calendarContainer.style.display = visible ? 'none' : 'block';
  if (!visible) renderCalendar();
});

// ‚¨ÖÔ∏è‚û°Ô∏è –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞ —Å–µ–¥–º–∏—Ü–∏—Ç–µ
prevWeekBtn.addEventListener('click', () => {
  weekStart.setDate(weekStart.getDate() - 7);
  renderCalendar();
});
nextWeekBtn.addEventListener('click', () => {
  weekStart.setDate(weekStart.getDate() + 7);
  renderCalendar();
});

// üßÆ –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–∞
function renderCalendar() {
  calendar.innerHTML = '';
  const week = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(weekStart);
    d.setDate(weekStart.getDate() + i);
    week.push(d);
  }

  week.forEach(day => {
    const dateStr = day.toISOString().split('T')[0];
    const dayDiv = document.createElement('div');
    dayDiv.classList.add('day');
    const options = { weekday: 'short', day: 'numeric', month: 'short' };
    dayDiv.innerHTML = `<h4>${day.toLocaleDateString('bg-BG', options)}</h4>`;

    for (let hour = 9; hour <= 18; hour++) {
      const hourDiv = document.createElement('div');
      hourDiv.classList.add('hour');
      hourDiv.textContent = `${hour}:00`;

      if (bookings[dateStr] && bookings[dateStr].includes(hour)) {
        hourDiv.classList.add('booked');
      } else {
        hourDiv.addEventListener('click', () => {
          selectedDate = dateStr;
          selectedTime = hour;
          selectedHour.textContent = `–ò–∑–±—Ä–∞—Ö—Ç–µ ${selectedDate} –≤ ${selectedTime}:00`;
        });
      }
      dayDiv.appendChild(hourDiv);
    }

    calendar.appendChild(dayDiv);
  });
}

// üì© –ò–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è
document.getElementById('bookingForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  if (!selectedDate || !selectedTime) {
    alert('–ú–æ–ª—è, –∏–∑–±–µ—Ä–µ—Ç–µ –¥–µ–Ω –∏ —á–∞—Å!');
    return;
  }

  const bookingData = {
    ownerName: document.getElementById('ownerName').value,
    dogName: document.getElementById('dogName').value,
    breed: document.getElementById('breed').value,
    phone: document.getElementById('phone').value,
    date: selectedDate,
    hour: selectedTime
  };

  const res = await fetch("/api/bookings", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(bookingData)
  });

  const data = await res.json();

  if (res.ok) {
    alert(data.message);
    document.getElementById('bookingForm').reset();
    selectedHour.textContent = '';
    await loadBookings(); // –ø—Ä–µ–∑–∞—Ä–µ–¥–∏ –∑–∞–µ—Ç–∏—Ç–µ —á–∞—Å–æ–≤–µ
  } else {
    alert(data.message || "–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∞–∑–≤–∞–Ω–µ!");
  }
});

// üîÑ –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ
loadBookings();
</script>
</body>
</html>
